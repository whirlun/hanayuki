<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
    {>"./layouts/master" /}
 <head>
 {+header}
 <title>
 {thread_info.title}
 </title>
  <script src="https://cdn.bootcss.com/showdown/1.7.3/showdown.min.js"></script>
 {/header}
<body>
{<bodyContent}
<div class="col-md-offset-1 col-md-10 thread-topic">
<h1 style="margin-left:30px">{thread_info.title}</h1>
<hr />
<div class="thread-user-info">
<img src="/img/avatar/{user_info.avatar}"/>
<p>{user_info.username}</p>
</div>
<p id="thread-content"></p>
</div>
<div class="col-md-offset-11 col-md-1">
<ul class="thread-slidebar">
<li><a href="javascript:void()" data-toggle="modal" data-target="#replythread"><span class="glyphicons glyphicons-comments"></span></li>
</ul>
</div>
<div class="thread-reply">
<div class="thread-user-info">
</div>
</div>
{/bodyContent}
<script>
var getreplies = function() {
	if({thread_info.rtotal} == 0)
		return;
	else{
	var replylist = [{thread_info.reply}];
	$.ajax({
		url: '/thread/reply',
		type: 'POST',
		dataType: 'application/json',
		data: {reply: replylist},
	})
	.done(function(data) {
        var jsondata = JSON.parse(data);
        for(var i = 0; i < jsondata['replies'].length; i++) {
        	
        }
	})
	.fail(function() {
		console.log("error");
	});
	
	}
};

var converter = new showdown.Converter();
Function.prototype.getMultilines = function () {  
var lines = new String(this);  
lines = lines.substring(lines.indexOf("/*")+3, lines.lastIndexOf("*/"));  
return lines;  
};

var text = function(){  
/* 
{thread_info.content}
*/  
}; 
var	html = converter.makeHtml(text.getMultilines());
$("#thread-content").html(html);
var push = function()  {
		var url = window.location.href.split("/")[4];
		$.ajax({
      	type: 'POST',
        contentType: 'application/json',
        url: '/thread/'+ url +'/reply',
        data: JSON.stringify($("#pushForm").serializeJSON()),
        success: function()  {var success = "<div class='text-center'><span class='glyphicon glyphicon-ok' aria-hidden='true' font-size='50px'></span></div><p class='lead text-center'>成功发送回复</p><br /><div class='text-center'><small>点击任意处以关闭此窗口</small>";
        $("#modalContent").html(success); $("#modalFooter").html("");$("#addThread").on("hidden.bs.modal", function() {  location.reload() });},
        error: function()  {var error = "<div class='text-center'><span class='glyphicon glyphicon-remove' aria-hidden='true' font-size='50px'></span></div><p class='lead text-center'>错误-发生内部错误，请刷新后再试</p>";
    $("#modalContent").html(error); $("#modalFooter").html("");$("#addThread").on("hidden.bs.modal", function()  { location.reload() });}
    })};
</script>
<div class="modal fade" id="replythread" tabindex="-1" role="dialog" aria-labelledby="replythread">
  <div class="modal-dialog" role="document">
    {#loginStatus}
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">回复讨论串</h4>
      </div>
      <div class="modal-body" id="modalContent">
        <form id="pushForm" action="/add" method="POST">
            <div class="form-group">
                <div class="btn-group index-toolbar" role="group" aria-label="addThreadToolbar">
                    <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-bold" aria-label="bold"></span></button>
                    <button type="button" class="btn btn-default"></button>
                    <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-italic" aria-label="italic"></span></button>
                    <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-console" aria-label="code"></span>
                </div>
                <textarea name="content" class="form-control" rows="10"></textarea>
                <input type="hidden" name="_csrf" value="{csrf}">
        </form>
      </div>
      <div class="modal-footer" id="modalFooter">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="push()">发送</button>
      </div>
    </div>
    {:notLogin}
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">请先登陆</h4>
      </div>
      <div class="modal-body" id="modalContent">
          <div style="text-align: center">
          <p>未登陆的游客没有权限开启讨论串，请登陆后再试</p>
          <small>请点此<a data-toggle="modal" data-target="#login" href="javascript:void(0)" onclick="$('#replythread').modal('toggle')">登陆</a>。没有账号？<a data-toggle="modal" data-target="#register" href="javascript:void(0)" onclick="$('#addThread').modal('toggle')">注册</a></small>
          </div>
      </div>
      <div class="modal-footer" id="modalFooter">
      </div>
    </div>
    {/loginStatus}
  </div>
</div>

</body>
</html>